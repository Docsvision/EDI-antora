= Настройка загрузки документов из оператора ЭДО

Для оператора ЭДО Диадок доступна возможность загружать документы для хранения в архиве {dv}.

Загрузка документов из оператора ЭДО выполняется на странице _Загрузка_ в _Справочнике настроек операторов ЮЗДО_. Для загрузки доступны исходящие документы и входящие документы.

[#incoming]
== Загрузка входящих документов

. В справочнике настроек операторов ЭДО в таблице _Загрузка входящих_ найдите колонку _Дополнительные атрибуты_ и добавьте XSLT-шаблон:
+
--
* `CardPackage\CardDocument_AdditionalExample.xml` — шаблон документа с дополнительными секциями и полями.
* `CardDefs\Xslt\UniInvoiceFields.xslt` — шаблон преобразования для УПД.
* `CardDefs\Xslt\UniInvoiceCorrFields.xslt` — шаблон преобразования для УКД.
--
+
.Шаблоны построены по следующей логике:
[source,xml]
----
<CardDocument> <.>

<.>
<MainInfo> <.>
<xsl:attribute name="TransferNumber"> <.>

<.>
<Goods> <.>
<GoodsRow> <.>
<xsl:attribute name="Order"> <.>
----
<.> Тип карточки.
<.> Для плоских секций:
<.> Псевдоним секции.
<.> Поле.
<.> Для коллекционных секций:
<.> Псевдоним секции.
<.> Новая строка секции.
<.> Поле.
+
.Пример проверки загрузки атрибутов
image::attributes-check.png[Пример проверки загрузки атрибутов]
+
. В колонке укажите XSLT для загрузки дополнительных параметров. В поставку включён пример XSLT и описание формата XML, откуда загружаются данные в карточку.
+
Указанный шаблон XSLT будет использоваться при загрузке документооборота, а так же при обычной синхронизации. Если шаблон не задан, будет выполнена загрузка стандартных полей. Если шаблон задан, в дополнение к стандартным полям будут также загружены те, что указаны в преобразовании. Для стандартных видов документов XSLT не используется.

Загружаются все документы, попадающие в диапазон дат, указанный при xref:configure-directory.adoc#activate-box[активации ящика организации]. Для каждого загружаемого документа в системе создаётся карточка документа определённого вида. Место хранения в системе и вид документа указываются в _Справочнике настроек операторов ЮЗДО_ в зависимости от атрибутов документа оператора ЭДО.

При попытке загрузить один и тот же документ с более поздним статусом, новая карточка не будет создана. Все файлы и атрибуты документа обновляются в уже существующей карточке {dv}.

.В карточку по каждому документу загружаются следующие файлы:
. Файл документа загружается как "основной".
. Загруженная электронная подпись файла документа может быть проверена.

[#outgoing]
== Загрузка исходящих документов

Загружаются все документы, попадающие в диапазон дат, указанный при xref:configure-directory.adoc#activate-box[активации ящика организации].

.Загружаются следующие виды документов:
... Формализованные документы:
+
* УПД.
* Акт.
* Накладная.
* Счет-фактура.
* УКД.
* ИСФ.
* КСФ.
* Исправление к УПД.
* Другие аналоги корректировочных документов.
+
... Неформализованные документы:
+
* Акт.
* Накладная.
* Транспортная накладная.
* Счет.
* Акт сверки.
* Детализация.
* Доверенность.
* Письмо.
* Протокол согласования цены.
* Реестр сертификатов.
* Ценовой лист.
+
... Договорные документы.

.Чтобы загрузить исходящие документы:
. Выберите _Имя класса компонента создания_.
+
По умолчанию колонка не содержит настройки, необходимо самостоятельно добавить те виды, которые требуется загружать. В качестве примера можно использовать настройки для входящих документов.
+
.По умолчанию это:
* `DocsVision.Edi.Runtime.BackOffice.OutgoingDocumentCreator` для неформализованных документов.
* `DocsVision.Edi.Runtime.UniversalDocument.SellerInvoice820Creator` для УПД 820.
* `DocsVision.Edi.Runtime.UniversalDocument.SellerInvoiceCreator` для УПД старого формата.
+
. В таблице _Загрузка исходящих_ найдите колонку _Дополнительные атрибуты_ и добавьте XSLT шаблон по аналогии с входящими документами. В папке инсталляции это шаблон `CardDefs\Xslt\UniInvoiceFields.xslt`.
. Чтобы использовать существующие виды документов, а не делать новые сразу после загрузки, для состояния УПД `SignedAndSent` можно использовать стандартный шаблон.
+
Для собственных видов в шаблоне необходимо прописать следующий ID состояния `BuiltInStateId = "80F6D41E-379C-44EB-B858-8A9CB1CC15F5"` самостоятельно. Допускается, например, сделать вид документа с начальным состоянием `Загружен` и переходами в остальные состояния. В таком случае состояние `Подготавливается` будет отсутствовать.

Загрузку документов выполняет БП `CardPackage\LoadOutgoingDocuments.xml`. Для входящих документов используется `CardPackage\LoadIncomingDocuments.xml`. Процедуру загрузки можно вызвать кодом.
