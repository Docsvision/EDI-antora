= Настройка работы с МЧД

Инструкция подходит как для {wincl}а, так и для {wc}а. Расширение позволяет использовать МЧД в диалогах подписания ЮЗДО.

.Сервис для работы с МЧД
image::attorney-service.png[Сервис для работы с МЧД]

.Чтобы настроить работу с МЧД:
. В _Справочнике настроек операторов ЮЗДО_ на вкладке _Сервисы_ выберите `DocsVision.Edi.Runtime.Diadoc` в качестве сервиса для работы с МЧД.
. В _Справочнике настроек операторов ЮЗДО_ на вкладке _Компоненты_ для выбранного вида карточек укажите:
+
* Имя класса компонента чтения: `DocsVision.Edi.Runtime.BackOffice.PowerOfAttorneyDataReader`.
* Имя класса компонента изменения: `DocsVision.Edi.Runtime.BackOffice.PowerOfAttorneyUpdater`.
+
. Импортируйте через DVExplorer БП для обработки отправленных МЧД: `CardPackage\SendEdiPowerOfAttorney.xml`.
. Для {wc}а импортируйте вид карточки документа ПКД menu:PowersOfAttorney[Data > SolutionOfPOA.sol] из примера "xref:5.5.17_m4d@webclient:programmer:other/powers-of-attorney.adoc[]".
. В карточку доверенности в соответствующем модуле системы добавьте две кнопки:
+
* Отправить МЧД со скриптом `EdiScriptHelper.SendPowerOfAttorney(Guid)` -- подписывает и отправляет файл МЧД.
+
** Если МЧД отправляется как файл, необходимо прикрепить файл и подпись.
** Если МЧД отправляется по номеру, необходимо, чтобы в доверенности были указаны номер и ИНН доверителя.
+
****
При наличии xref:ROOT:requirements.adoc#license[опции лицензии] {dv} _Модуль регистрации МЧД через провайдеров внешнего ЭДО_ после подписания возможно отправлять доверенность на регистрацию в распределённый реестр ФНС. В таком случае в разметке ПКД и разметке задания на подписание ПКД заменить стандартный скрипт подписания на `signAndSendPowerOfAttorneyToRegistrationAsFileFromTask` и переименовать кнопку подписания в *Подписать и отправить*.
****
+
* Отозвать МЧД со скриптом `EdiScriptHelper.RevokePowerOfAttorney(Guid)` -- отвязывает МЧД от сотрудника в Диадок.
+
. В карточку доверенности добавьте ЭУ `_Журнал МЧД_`

.Для работы с МЧД предназначены два метода:
* Метод `public bool SendPowerOfAttorney(Guid powerOfAttorneyCardId)` передает в Диадок для регистрации номер МЧД (в СКД в секции `MainInfo` поле `PowerOfAttorneyNumber`) и ИНН доверителя (в СКД в секции `MainInfo` поле `PrincipalINN`).
** При этом сценарии МЧД должна быть предварительно зарегистрирована в реестре ФНС и после передачи из ДВ в Диадок регистрационного номера МЧД и ИНН доверителя МЧД в Диадок привязывается к пользователю.
* Метод `public bool SendPowerOfAttorney(Guid powerOfAttorneyCardId, bool sendAsFile)` передает в Диадок для регистрации файл МЧД (в СКД в секции `MainInfo` поле `MachineReadablePowerOfAttorney`) и файл подписи (в СКД в секции `MainInfo` поле `Signature`) и регистрирует.
** При этом сценарии МЧД в Диадок привязывается к пользователю и проходит регистрацию в реестре ФНС.

WARNING: У видов формализованных документов по умолчанию не установлены флаги о необходимости использования доверенности. Необходимо самостоятельно установить флаг "xref:5.5.5@backoffice:desdirs:card-kinds/document/sign-card.adoc#attorney[Использовать МЧД при подписании]" в справочнике видов карточек для требуемых документов.