= Настройка загрузки документов из оператора ЭДО

Для оператора ЭДО Диадок доступна возможность загружать документы для хранения в архиве Docsvision.

Загрука документов из оператора ЭДО выполняется на странице *Загрузка* в [.dfn .term]_Справочнике настроек операторов ЮЗДО_. Для загрузки доступны исходящие документы и входящие документы.

[[loading__section_uk2_hc2_jtb]]
=== Загрузка входящих документов

. В справочнике настроек операторов ЭДО в таблице "Загрузка входящих" найдите колонку [.keyword .wintitle]*Дополнительные атрибуты* и добавьте XSLT шаблон:
* [.ph .filepath]`CardPackage\CardDocument_AdditionalExample.xml` — шаблон документа с дополнительными секциями и полями.
* [.ph .filepath]`CardDefs\Xslt\UniInvoiceFields.xslt` — шаблон преобразования для УПД.
* [.ph .filepath]`CardDefs\Xslt\UniInvoiceCorrFields.xslt` — шаблон преобразования для УКД.
+
Шаблоны построены по следующей логике:
+
[source,pre,codeblock,language-xml]
----
<CardDocument> <!-- Тип карточки -->

<!-- Для плоских секций: -->
<MainInfo> <!-- Псевдоним секции -->
<xsl:attribute name="TransferNumber"> <!-- Поле -->

<!-- Для коллеционных секций: -->
<Goods> <!-- Псевдоним секции -->
<GoodsRow> <!-- Новая строка секции -->
<xsl:attribute name="Order"> <!-- Поле -->
----
+
image::attributes.png[[.fig--title-label]##Рис. 1. ##Пример проверки загрузки атрибутов]
. В колонке укажите XSLT для загрузки дополнительных параметров. В поставку включён пример XSLT и описание формата XML, откуда загружаются данные в карточку.
+
Указанный шаблон XSLT будет использоваться при выполнении загрузки документооборота, а так же при обычной синхронизации. Если шаблон не задан, будет выполнена загрузка стандартных полей. Если шаблон задан, в дополнение к стандартным полям будут также загружены те, что указаны в преобразовании. Для стандартных видов документов XSLT не используется.

Загружаются все документы, попадающие в диапазон дат, указанный при xref:ActivationOrgBox.adoc[активации ящика организации]. Для каждого загружаемого документа в системе создаётся карточка документа определённого вида. Место хранения в системе и вид документа указываются в [.dfn .term]_Справочнике настроек операторов ЮЗДО_ в зависимости от атрибутов документа оператора ЭДО.

При попытке загрузить один и тот же документ с более поздним статусом, новая карточка не будет создана. Все файлы и атрибуты документа обновляются в уже существующей карточке Docsvision.

В карточку по каждому документу загружаются следующие файлы:

. Файл документа загружается как "основной".
. Загруженная электронная подпись файла документа может быть проверена.

[[loading__section_khz_f22_jtb]]
=== Загрузка исходящих документов

Загружаются все документы, попадающие в диапазон дат, указанный при xref:ActivationOrgBox.adoc[активации ящика организации].

Загружаются следующие виды документов:

* Формализованные документы: УПД, акт, накладная, счет-фактура, УКД, ИСФ, КСФ, исправление к УПД и другие аналоги корректировочных документов.
* Неформализованные документы: акт, накладная, транспортная накладная, счет, акт сверки, детализация, доверенность, письмо, протокол согласования цены, реестр сертификатов, ценовой лист.
* Договорные документы.

Чтобы загрузить исходящие документы:

. Выберите [.dfn .term]_Имя класса компонента создания_.
+
По умолчанию колонка не содержит настройки, необходимо самостоятельно добавить те виды, которые требуется загружать. В качестве примера можно использовать настройки для входящих документов.
+
По умолчанию это:
* [.keyword .apiname]#DocsVision.Edi.Runtime.BackOffice.OutgoingDocumentCreator# для неформализованных документов.
* [.keyword .apiname]#DocsVision.Edi.Runtime.UniversalDocument.SellerInvoice820Creator# для УПД 820.
* [.keyword .apiname]#DocsVision.Edi.Runtime.UniversalDocument.SellerInvoiceCreator# для УПД старого формата.
. В таблице "Загрузка исходящих" найдите колонку [.keyword .wintitle]*Дополнительные атрибуты* и добавьте XSLT шаблон по аналогии с входящими документами. В папке инсталляции это шаблон [.ph .filepath]`CardDefs\Xslt\UniInvoiceFields.xslt`.
. Чтобы использовать существующие виды документов, а не делать новые сразу после загрузки, для состояния УПД [.dfn .term]_SignedAndSent_ можно использовать стандартный шаблон.
+
Для собственных видов в шаблоне необходимо прописать следующий ID состояния [.keyword .apiname]#BuiltInStateId = "80F6D41E-379C-44EB-B858-8A9CB1CC15F5"# самостоятельно. Допускается, например, сделать вид документа с начальным состоянием "Загружен" и переходами в остальные состояния. В таком случае состояние "Подготавливается" будеть отсутствовать.

Загрузку документов выполняет БП [.ph .filepath]`CardPackage\LoadOutgoingDocuments.xml`. Для входящих документов используется [.ph .filepath]`CardPackage\LoadIncomingDocuments.xml`. Процедуру загрузки можно вызвать кодом.
