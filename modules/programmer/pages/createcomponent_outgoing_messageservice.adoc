= Разработка компонента сервиса ответных сообщений

Далее приведена часть исходного кода (только публичные методы) примера реализации класса [.keyword .apiname]#OutgoingMessagesService# для отправки ответа на неформализованный документ.

[source,pre,codeblock,language-csharp]
----
// сервис отправки исходящих событий
OutgoingMessagesService outgoingMessagesService = new OutgoingMessagesService(cardControl.ObjectContext);

// поиск карточки сообщений, для которой нужен ответ, для документа cardId
EdiMessage messageCard = outgoingMessagesService.FindIncomingMessageCards(cardId).FirstOrDefault();

// ... вот это пропускаем, если уже есть готовая ответная подпись
// ... но очень аккуратно, иначе можно отправить как ответную оригинальную подпись контрагента

// сервис изменения документа
DocumentUpdaterService documentUpdaterService = new DocumentUpdaterService(objectContext);
// X509Certificate2 certificate на входе - это сертификат, которым делаем новые подписи
Guid newSignatureGroupId = documentUpdaterService.CreateNewSignatures(cardId, certificate, false);

// ... конец создания новой подписи

// сервис чтения данных из карточек
DataReaderService dataReaderService = new DataReaderService(objectContext);
// получаем свежеподписанные файлы
// при наличии готовой ответной подписи, newSignatureGroupId - это Id подписи из списка подписей
ItemCollection<DocumentFileData> signedFiles = dataReaderService.GetSignedFiles(cardId, newSignatureGroupId);

if (outgoingMessagesService.CreateOutgoingSignatureReplies(cardId, signedFiles).Any())
{
 // ... все хорошо, подписи отправили
 // Ответные подписи успешно отправлены.
}
else
{
 // ... по карточке сообщения уже некому отправлять ответ - отработал другой скрипт, кто-то отправил руками и т.п.
 // Не существует связанных писем в ящике ЮЗДО, ожидающих ответных действий по ним. Отправка произведена не будет.
}
----

Далее приведён пример отправки отказа от подписи, сервисы те же, что в предыдущем примере:

[source,pre,codeblock,language-csharp]
----
// commentText - причина отказа, X509Certificate2 certificate - сертификат
outgoingMessagesService.CreateOutgoingRejectionReplies(cardId, commentText, certificate);
----

Следующий пример демонстрирует отправку положительного ответа на УПД или УКД:

[source,pre,codeblock]
----
// получение данных ответа для ответа из карточки
string invoiceReplyData = dataReaderService.GetInvoiceReplyData(cardId);

// генерация файла ответа, подписание его сертификатом X509Certificate2 certificate, отправка
if (outgoingMessagesService.CreateOutgoingInvoiceReplies(cardId, certificate, invoiceReplyData).Any())
{
 // ... отправили успешно
}
else
{
 // ... не отправили, то же, что и для неформализованных
}
----
